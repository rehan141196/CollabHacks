{"version":3,"sources":["conversation.js"],"names":["Conversation","WebexPlugin","extend","namespace","acknowledge","conversation","object","activity","reject","Error","_inferConversationUrl","then","prepare","verb","target","prepareConversation","objectType","id","url","a","submit","add","participant","webex","internal","user","asUUID","create","kmsMessage","method","uri","resourceUri","userIds","params","options","participants","length","all","map","catch","err","allowPartialCreation","undefined","unshift","device","userId","validParticipants","filter","forceGrouped","InvalidUserCreation","skipOneOnOneFetch","_createOneOnOne","_maybeCreateOneOnOneThenPost","_createGrouped","c","files","share","activities","items","push","delete","download","item","isEncrypted","Boolean","scr","key","shunt","EventEmitter","promise","encryption","loc","_downloadUnencryptedFile","on","args","emit","res","file","logger","info","displayName","name","type","mimeType","responseType","request","body","expand","actor","get","qs","uuidEntryFormat","personRefresh","activitiesLimit","includeConvWithDeletedUserUUID","includeParticipants","resolve","service","resource","_recordUUIDs","leave","querystring","stringify","authId","list","_list","deferDecrypt","listLeft","listActivities","_listActivities","mentions","listMentions","muteMentions","tag","tags","muteMessages","cardAction","inputs","parentActivity","parent","post","message","act","clientTempId","uuid","v4","parentActivityId","activityType","forEach","split","pop","content","processActivityEvent","event","transform","removeAllMuteTags","untag","makeShare","ShareActivity","assign","avatar","size","enableThumbnails","updateTypingStatus","eventType","typing","conversationId","transcode","async","trigger","unassign","unmuteMentions","unmuteMessages","update","updateKey","_updateKey","kms","createUnboundKeys","count","keys","k","defaultActivityEncryptionKeyUrl","keyUris","_create","payload","forceCreate","_prepareConversationForCreation","feature","getFeature","haMessagingEnabled","getServiceUrl","process","env","NODE_ENV","warn","participantsLimit","published","reverse","comment","html","reason","statusCode","recordUUID","entryUUID","prototype","submitSimpleActivity","submitModerationChangeActivity","moderator","fnName","startsWith","submitSpacePropertyActivity","submitObjectActivity"],"mappings":"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","file":"conversation.js","sourcesContent":["/*!\n * Copyright (c) 2015-2019 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport querystring from 'querystring';\nimport {EventEmitter} from 'events';\n\nimport {proxyEvents, tap} from '@webex/common';\nimport {WebexPlugin} from '@webex/webex-core';\nimport {cloneDeep, defaults, isArray, isObject, isString, last, map, merge, omit, pick, uniq} from 'lodash';\nimport {readExifData} from '@webex/helper-image';\nimport uuid from 'uuid';\n\nimport {InvalidUserCreation} from './convo-error';\nimport ShareActivity from './share-activity';\n\n\nconst Conversation = WebexPlugin.extend({\n  namespace: 'Conversation',\n\n  acknowledge(conversation, object, activity) {\n    if (!isObject(object)) {\n      return Promise.reject(new Error('`object` must be an object'));\n    }\n\n    return this._inferConversationUrl(conversation)\n      .then(() => this.prepare(activity, {\n        verb: 'acknowledge',\n        target: this.prepareConversation(conversation),\n        object: {\n          objectType: 'activity',\n          id: object.id,\n          url: object.url\n        }\n      }))\n      .then((a) => this.submit(a));\n  },\n\n  /**\n   * Adds a participant to a conversation\n   * @param {Object} conversation\n   * @param {Object|string} participant\n   * @param {Object} activity Reference to the activity that will eventually be\n   * posted. Use this to (a) pass in e.g. clientTempId and (b) render a\n   * provisional activity\n   * @returns {Promise<Activity>}\n   */\n  add(conversation, participant, activity) {\n    return this._inferConversationUrl(conversation)\n      .then(() => this.webex.internal.user.asUUID(participant, {create: true}))\n      .then((id) => this.prepare(activity, {\n        verb: 'add',\n        target: this.prepareConversation(conversation),\n        object: {\n          id,\n          objectType: 'person'\n        },\n        kmsMessage: {\n          method: 'create',\n          uri: '/authorizations',\n          resourceUri: '<KRO>',\n          userIds: [\n            id\n          ]\n        }\n      })\n        .then((a) => this.submit(a)));\n  },\n\n  /**\n   * Creates a conversation\n   * @param {Object} params\n   * @param {Array<Participant>} params.participants\n   * @param {Array<File>} params.files\n   * @param {string} params.comment\n   * @param {string} params.html\n   * @param {Object} params.displayName\n   * @param {Object} options\n   * @param {Boolean} options.allowPartialCreation\n   * @param {Boolean} options.forceGrouped\n   * @param {Boolean} options.skipOneOnOneFetch skips checking 1:1 exists before creating conversation\n   * @returns {Promise<Conversation>}\n   */\n  create(params, options) {\n    options = options || {};\n\n    if (!params.participants || params.participants.length === 0) {\n      return Promise.reject(new Error('`params.participants` is required'));\n    }\n\n    return Promise.all(params.participants.map((participant) => this.webex.internal.user.asUUID(participant, {create: true})\n      // eslint-disable-next-line arrow-body-style\n      .catch((err) => {\n        return options.allowPartialCreation ? undefined : Promise.reject(err);\n      })))\n      .then((participants) => {\n        participants.unshift(this.webex.internal.device.userId);\n        participants = uniq(participants);\n\n        const validParticipants = participants.filter((participant) => participant);\n\n        params.participants = validParticipants;\n\n        // check if original participants list was to create a 1:1\n        if (participants.length === 2 && !(options && options.forceGrouped)) {\n          if (!params.participants[1]) {\n            return Promise.reject(new InvalidUserCreation());\n          }\n\n          if (options.skipOneOnOneFetch) {\n            return this._createOneOnOne(params);\n          }\n\n          return this._maybeCreateOneOnOneThenPost(params, options);\n        }\n\n        return this._createGrouped(params, options);\n      })\n      .then((c) => {\n        if (!params.files) {\n          return c;\n        }\n\n        return this.webex.internal.conversation.share(c, params.files)\n          .then((a) => {\n            c.activities.items.push(a);\n\n            return c;\n          });\n      });\n  },\n\n  delete(conversation, object, activity) {\n    if (!isObject(object)) {\n      return Promise.reject(new Error('`object` must be an object'));\n    }\n\n    return this._inferConversationUrl(conversation)\n      .then(() => this.prepare(activity, {\n        verb: 'delete',\n        target: this.prepareConversation(conversation),\n        object: pick(object, 'id', 'url', 'objectType')\n      }))\n      .then((a) => this.submit(a));\n  },\n\n  /**\n   * Downloads the file specified in item.scr or item.url\n   * @param {Object} item\n   * @param {Object} item.scr\n   * @param {string} item.url\n   * @param {Object} options\n   * @param {Object} options.headers\n   * @returns {Promise<File>}\n   */\n  download(item, options) {\n    const isEncrypted = Boolean(item.scr && item.scr.key);\n    const shunt = new EventEmitter();\n    let promise;\n\n    if (isEncrypted) {\n      promise = this.webex.internal.encryption.download(item.scr);\n    }\n    else if (item.scr && item.scr.loc) {\n      promise = this._downloadUnencryptedFile(item.scr.loc, options);\n    }\n    else {\n      promise = this._downloadUnencryptedFile(item.url, options);\n    }\n\n    promise = promise\n      .on('progress', (...args) => shunt.emit('progress', ...args))\n      .then((res) => readExifData(item, res))\n      .then((file) => {\n        this.logger.info('conversation: file downloaded');\n\n        if (item.displayName && !file.name) {\n          file.name = item.displayName;\n        }\n\n        if (!file.type && item.mimeType) {\n          file.type = item.mimeType;\n        }\n\n        return file;\n      });\n\n    proxyEvents(shunt, promise);\n\n    return promise;\n  },\n\n  /**\n   * Downloads an unencrypted file\n   * @param {string} uri\n   * @param {Object} options\n   * @param {Ojbect} options.headers\n   * @returns {Promise<File>}\n   */\n  _downloadUnencryptedFile(uri, options) {\n    options = options || {};\n    Object.assign(options, {\n      uri,\n      responseType: 'buffer'\n    });\n\n    const promise = this.request(options)\n      .then((res) => res.body);\n\n    proxyEvents(options.download, promise);\n\n    return promise;\n  },\n\n  /**\n   * Helper method that expands a set of parameters into an activty object\n   * @param {string} verb\n   * @param {Object} object\n   * @param {Object} target\n   * @param {Object|string} actor\n   * @returns {Object}\n   */\n  expand(verb, object, target, actor) {\n    const activity = {\n      actor,\n      objectType: 'activity',\n      verb\n    };\n\n    if (!actor) {\n      actor = this.webex.internal.device.userId;\n    }\n\n    if (isString(actor)) {\n      activity.actor = {\n        objectType: 'person',\n        id: actor\n      };\n    }\n\n    if (object) {\n      activity.object = object;\n    }\n\n    if (target) {\n      activity.target = target;\n    }\n\n    return activity;\n  },\n\n  /**\n   * Fetches a single conversation\n   * @param {Object} conversation\n   * @param {Object} options\n   * @returns {Promise<Conversation>}\n   */\n  get(conversation, options) {\n    return this._inferConversationUrl(conversation)\n      .then(() => {\n        const {user, url} = conversation;\n\n        options = options || {};\n\n        const params = {\n          qs: Object.assign({\n            uuidEntryFormat: true,\n            personRefresh: true,\n            activitiesLimit: 0,\n            includeConvWithDeletedUserUUID: false,\n            includeParticipants: false\n          }, omit(options, 'id', 'user', 'url'))\n        };\n\n        // Default behavior is to set includeParticipants=false,\n        // which makes the payload lighter by removing participant info.\n        // If the caller explicitly sets the participantAckFilter or\n        // participantsLimit, we don't want that default setting.\n        if (('participantAckFilter' in options) || ('participantsLimit' in options)) {\n          delete params.qs.includeParticipants;\n        }\n\n        return Promise.resolve(user ? this.webex.internal.user.asUUID(user) : null)\n          .then((userId) => {\n            if (userId) {\n              Object.assign(params, {\n                service: 'conversation',\n                resource: `conversations/user/${userId}`\n              });\n            }\n            else {\n              params.uri = url;\n            }\n\n            return this.request(params);\n          });\n      })\n      .then(tap((res) => this._recordUUIDs(res.body)))\n      .then((res) => res.body);\n  },\n\n  /**\n   * Leaves the conversation or removes the specified user from the specified\n   * conversation\n   * @param {Object} conversation\n   * @param {Object|string} participant If not specified, defaults to current\n   * user\n   * @param {Object} activity Reference to the activity that will eventually be\n   * posted. Use this to (a) pass in e.g. clientTempId and (b) render a\n   * provisional activity\n   * @returns {Promise<Activity>}\n   */\n  leave(conversation, participant, activity) {\n    return this._inferConversationUrl(conversation)\n      .then(() => {\n        if (!participant) {\n          participant = this.webex.internal.device.userId;\n        }\n\n        return this.webex.internal.user.asUUID(participant)\n          .then((id) => this.prepare(activity, {\n            verb: 'leave',\n            target: this.prepareConversation(conversation),\n            object: {\n              id,\n              objectType: 'person'\n            },\n            kmsMessage: {\n              method: 'delete',\n              uri: `<KRO>/authorizations?${querystring.stringify({authId: id})}`\n            }\n          }));\n      })\n      .then((a) => this.submit(a));\n  },\n\n  /**\n   * Lists a set of conversations. By default does not fetch activities or\n   * participants\n   * @param {Object} options\n   * @param {boolean} options.deferDecrypt - when true, deferDecrypt tells the\n   * payload transformer to normalize (but not decrypt) each received\n   * conversation. Instead, the received conversations will each have a bound\n   * decrypt method that can be executed at the consumer's leisure\n   * @returns {Promise<Array<Conversation>>}\n   */\n  list(options) {\n    return this._list({\n      service: 'conversation',\n      resource: 'conversations',\n      qs: omit(options, 'deferDecrypt'),\n      deferDecrypt: options.deferDecrypt\n    });\n  },\n\n  /**\n   * Lists the conversations the current user has left. By default does not\n   * fetch activities or participants\n   * @param {Object} options\n   * @returns {Promise<Array<Conversation>>}\n   */\n  listLeft(options) {\n    return this._list({\n      service: 'conversation',\n      resource: 'conversations/left',\n      qs: options\n    });\n  },\n\n  /**\n   * List activities for the specified conversation\n   * @param {Object} options\n   * @returns {Promise<Array<Activity>>}\n   */\n  listActivities(options) {\n    return this._listActivities(Object.assign(options, {mentions: false}));\n  },\n\n  /**\n   * Lists activities in which the current user was mentioned\n   * @param {Object} options\n   * @returns {Promise<Array<Activity>>}\n   */\n  listMentions(options) {\n    return this._listActivities(Object.assign(options, {mentions: true}));\n  },\n\n  /**\n   * Mutes the mentions of a conversation\n   * @param {Conversation~ConversationObject} conversation\n   * @param {Conversation~ActivityObject} activity\n   * @returns {Promise} Resolves with the created activity\n   */\n  muteMentions(conversation, activity) {\n    return this.tag(conversation, {\n      tags: ['MENTION_NOTIFICATIONS_OFF']\n    }, activity);\n  },\n\n  /**\n   * Mutes the messages of a conversation\n   * @param {Conversation~ConversationObject} conversation\n   * @param {Conversation~ActivityObject} activity\n   * @returns {Promise} Resolves with the created activity\n   */\n  muteMessages(conversation, activity) {\n    return this.tag(conversation, {\n      tags: ['MESSAGE_NOTIFICATIONS_OFF']\n    }, activity);\n  },\n\n  cardAction(conversation, inputs, parentActivity, activity = {}) {\n    activity.parent = {\n      id: parentActivity.id,\n      type: 'cardAction'\n    };\n\n    return this._inferConversationUrl(conversation)\n      .then(() => this.prepare(activity, {\n        verb: 'cardAction',\n        target: this.prepareConversation(conversation),\n        object: Object.assign({objectType: 'submit'}, inputs)\n      }))\n      .then((a) => this.submit(a));\n  },\n\n  /**\n   * Posts a message to a conversation\n   * @param {Object} conversation\n   * @param {Object|string} message if string, treated as plaintext; if object,\n   * assumed to be object property of `post` activity\n   * @param {Object} activity Reference to the activity that will eventually be\n   * posted. Use this to (a) pass in e.g. clientTempId and (b) render a\n   * provisional activity\n   * @returns {Promise<Activity>}\n   */\n  post(conversation, message, activity) {\n    if (isString(message)) {\n      message = {\n        displayName: message\n      };\n    }\n\n    return this._inferConversationUrl(conversation)\n      .then(() => this.prepare(activity, {\n        verb: 'post',\n        target: this.prepareConversation(conversation),\n        object: Object.assign({objectType: 'comment'}, message)\n      }))\n      .then((a) => this.submit(a));\n  },\n\n  prepareConversation(conversation) {\n    return defaults(pick(conversation, 'id', 'url', 'objectType', 'defaultActivityEncryptionKeyUrl', 'kmsResourceObjectUrl'), {\n      objectType: 'conversation'\n    });\n  },\n\n  prepare(activity, params) {\n    params = params || {};\n    activity = activity || {};\n\n    return Promise.resolve(activity.prepare ? activity.prepare(params) : activity)\n      .then((act) => {\n        defaults(act, {\n          verb: params.verb,\n          kmsMessage: params.kmsMessage,\n          objectType: 'activity',\n          clientTempId: uuid.v4(),\n          actor: this.webex.internal.device.userId\n        });\n\n        // Workaround because parent is a reserved props in Ampersand\n        if ((activity.parentActivityId && activity.activityType) || (activity.parent && activity.parent.id && activity.parent.type)) {\n          act.parent = {\n            id: activity.parentActivityId || activity.parent.id,\n            type: activity.activityType || activity.parent.type\n          };\n        }\n\n        if (isString(act.actor)) {\n          act.actor = {\n            objectType: 'person',\n            id: act.actor\n          };\n        }\n\n        ['actor', 'object'].forEach((key) => {\n          if (params[key]) {\n            act[key] = act[key] || {};\n            defaults(act[key], params[key]);\n          }\n        });\n\n        if (params.target) {\n          merge(act, {\n            target: pick(params.target, 'id', 'url', 'objectType', 'kmsResourceObjectUrl', 'defaultActivityEncryptionKeyUrl')\n          });\n        }\n\n        ['object', 'target'].forEach((key) => {\n          if (act[key] && act[key].url && !act[key].id) {\n            act[key].id = act[key].url.split('/').pop();\n          }\n        });\n\n        ['actor', 'object', 'target'].forEach((key) => {\n          if (act[key] && !act[key].objectType) {\n            // Reminder: throwing here because it's the only way to get out of\n            // this loop in event of an error.\n            throw new Error(`\\`act.${key}.objectType\\` must be defined`);\n          }\n        });\n\n        if (act.object && act.object.content && !act.object.displayName) {\n          return Promise.reject(new Error('Cannot submit activity object with `content` but no `displayName`'));\n        }\n\n        return act;\n      });\n  },\n\n  /**\n   * Handles incoming conversation.activity mercury messages\n   * @param {Event} event\n   * @returns {Promise}\n   */\n  processActivityEvent(event) {\n    return this.webex.transform('inbound', event)\n      .then(() => event);\n  },\n\n  /**\n   * Removes all mute-related tags\n   * @param {Conversation~ConversationObject} conversation\n   * @param {Conversation~ActivityObject} activity\n   * @returns {Promise} Resolves with the created activity\n   */\n  removeAllMuteTags(conversation, activity) {\n    return this.untag(conversation, {\n      tags: [\n        'MENTION_NOTIFICATIONS_OFF',\n        'MENTION_NOTIFICATIONS_ON',\n        'MESSAGE_NOTIFICATIONS_OFF',\n        'MESSAGE_NOTIFICATIONS_ON'\n      ]\n    }, activity);\n  },\n\n  /**\n   * Creates a ShareActivty for the specified conversation\n   * @param {Object} conversation\n   * @param {Object} activity\n   * @returns {ShareActivty}\n   */\n  makeShare(conversation, activity) {\n    // if we pass activity as null then it does not take care of the\n    // clientTempId created by the web-client while making the provisional\n    // activity, hence we need to pass the activity which was created by the\n    // web-client. This fixes the issue where the image activities do not come\n    // back properly oriented from the server since the clientTempId is missing\n    return ShareActivity.create(conversation, activity, this.webex);\n  },\n\n  /**\n   * Assigns an avatar to a room\n   * @param {Object} conversation\n   * @param {File} avatar\n   * @returns {Promise<Activity>}\n   */\n  assign(conversation, avatar) {\n    if ((avatar.size || avatar.length) > 1024 * 1024) {\n      return Promise.reject(new Error('Room avatars must be less than 1MB'));\n    }\n\n    return this._inferConversationUrl(conversation)\n      .then(() => {\n        const activity = ShareActivity.create(conversation, null, this.webex);\n\n        activity.enableThumbnails = false;\n        activity.add(avatar);\n\n        return this.prepare(activity, {\n          target: this.prepareConversation(conversation)\n        });\n      })\n      .then((a) => {\n        // yes, this seems a little hacky; will likely be resolved as a result\n        // of #213\n        a.verb = 'assign';\n\n        return this.submit(a);\n      });\n  },\n\n  /**\n   * Sets the typing status of the current user in a conversation\n   *\n   * @param {Object} conversation\n   * @param {Object} options\n   * @param {boolean} options.typing\n   * @returns {Promise}\n   */\n  updateTypingStatus(conversation, options) {\n    if (!conversation.id) {\n      if (conversation.url) {\n        conversation.id = conversation.url.split('/').pop();\n      }\n      else {\n        return Promise.reject(new Error('conversation: could not identify conversation'));\n      }\n    }\n\n    let eventType;\n\n    if (options.typing) {\n      eventType = 'status.start_typing';\n    }\n    else {\n      eventType = 'status.stop_typing';\n    }\n\n    const params = {\n      method: 'POST',\n      service: 'conversation',\n      resource: 'status/typing',\n      body: {\n        conversationId: conversation.id,\n        eventType\n      }\n    };\n\n    return this.request(params);\n  },\n\n  /**\n   * Shares files to the specified converstion\n   * @param {Object} conversation\n   * @param {ShareActivity|Array<File>} activity\n   * @returns {Promise<Activity>}\n   */\n  share(conversation, activity) {\n    if (isArray(activity)) {\n      activity = {\n        object: {\n          files: activity\n        }\n      };\n    }\n\n    return this._inferConversationUrl(conversation)\n      .then(() => {\n        if (!(activity instanceof ShareActivity)) {\n          activity = ShareActivity.create(conversation, activity, this.webex);\n        }\n\n        return this.prepare(activity, {\n          target: this.prepareConversation(conversation)\n        });\n      })\n      .then((a) => this.submit(a));\n  },\n\n  /**\n   * Submits an activity to the conversation service\n   * @param {Object} activity\n   * @returns {Promise<Activity>}\n   */\n  submit(activity) {\n    const params = {\n      method: 'POST',\n      service: 'conversation',\n      resource: activity.verb === 'share' ? 'content' : 'activities',\n      body: activity,\n      qs: {\n        personRefresh: true\n      }\n    };\n\n    if (activity.verb === 'share') {\n      Object.assign(params.qs, {\n        transcode: true,\n        async: false\n      });\n    }\n\n    // triggers user-activity to reset logout timer\n    this.webex.trigger('user-activity');\n\n    return this.request(params)\n      .then((res) => res.body);\n  },\n\n  /**\n   * Remove the avatar from a room\n   * @param {Conversation~ConversationObject} conversation\n   * @param {Conversation~ActivityObject} activity\n   * @returns {Promise}\n   */\n  unassign(conversation, activity) {\n    return this._inferConversationUrl(conversation)\n      .then(() => this.prepare(activity, {\n        verb: 'unassign',\n        target: this.prepareConversation(conversation),\n        object: {\n          objectType: 'content',\n          files: {\n            items: []\n          }\n        }\n      }))\n      .then((a) => this.submit(a));\n  },\n\n  /**\n   * Mutes the mentions of a conversation\n   * @param {Conversation~ConversationObject} conversation\n   * @param {Conversation~ActivityObject} activity\n   * @returns {Promise} Resolves with the created activity\n   */\n  unmuteMentions(conversation, activity) {\n    return this.tag(conversation, {\n      tags: ['MENTION_NOTIFICATIONS_ON']\n    }, activity);\n  },\n\n  /**\n   * Mutes the messages of a conversation\n   * @param {Conversation~ConversationObject} conversation\n   * @param {Conversation~ActivityObject} activity\n   * @returns {Promise} Resolves with the created activity\n   */\n  unmuteMessages(conversation, activity) {\n    return this.tag(conversation, {\n      tags: ['MESSAGE_NOTIFICATIONS_ON']\n    }, activity);\n  },\n\n  update(conversation, object, activity) {\n    if (!isObject(object)) {\n      return Promise.reject(new Error('`object` must be an object'));\n    }\n\n    return this._inferConversationUrl(conversation)\n      .then(() => this.prepare(activity, {\n        verb: 'update',\n        target: this.prepareConversation(conversation),\n        object\n      }))\n      .then((a) => this.submit(a));\n  },\n\n  /**\n   * Sets a new key for the conversation\n   * @param {Object} conversation\n   * @param {Key|string} key (optional)\n   * @param {Object} activity Reference to the activity that will eventually be\n   * posted. Use this to (a) pass in e.g. clientTempId and (b) render a\n   * provisional activity\n   * @returns {Promise<Activity>}\n   */\n  updateKey(conversation, key, activity) {\n    return this._inferConversationUrl(conversation)\n      .then(() => this.get(conversation, {\n        activitiesLimit: 0,\n        includeParticipants: true\n      }))\n      .then((c) => this._updateKey(c, key, activity));\n  },\n\n  /**\n   * Sets a new key for the conversation\n   * @param {Object} conversation\n   * @param {Key|string} key (optional)\n   * @param {Object} activity Reference to the activity that will eventually be\n   * posted. Use this to (a) pass in e.g. clientTempId and (b) render a\n   * provisional activity\n   * @private\n   * @returns {Promise<Activity>}\n   */\n  _updateKey(conversation, key, activity) {\n    return Promise.resolve(key || this.webex.internal.encryption.kms.createUnboundKeys({count: 1}))\n      .then((keys) => {\n        const k = isArray(keys) ? keys[0] : keys;\n        const params = {\n          verb: 'updateKey',\n          target: this.prepareConversation(conversation),\n          object: {\n            defaultActivityEncryptionKeyUrl: k.uri,\n            objectType: 'conversation'\n          }\n        };\n\n        // Reminder: the kmsResourceObjectUrl is only usable if there is\n        // defaultActivityEncryptionKeyUrl.\n        if (conversation.defaultActivityEncryptionKeyUrl) {\n          params.kmsMessage = {\n            method: 'update',\n            resourceUri: '<KRO>',\n            uri: k.uri\n          };\n        }\n        else {\n          params.kmsMessage = {\n            method: 'create',\n            uri: '/resources',\n            userIds: map(conversation.participants.items, 'id'),\n            keyUris: [\n              k.uri\n            ]\n          };\n        }\n\n        return this.prepare(activity, params)\n          .then((a) => this.submit(a));\n      });\n  },\n\n  /**\n   * @param {Object} payload\n   * @param {Object} options\n   * @private\n   * @returns {Promise<Activity>}\n   */\n  _create(payload, options) {\n    options = options || {};\n\n    return this.request({\n      method: 'POST',\n      service: 'conversation',\n      resource: 'conversations',\n      body: payload,\n      qs: {\n        forceCreate: options.allowPartialCreation\n      }\n    })\n      .then((res) => res.body);\n  },\n\n  /**\n   * @param {Object} params\n   * @param {Object} options\n   * @private\n   * @returns {Promise}\n   */\n  _createGrouped(params, options) {\n    return this._create(this._prepareConversationForCreation(params), options);\n  },\n\n  /**\n   * @param {Object} params\n   * @param {Object} options\n   * @private\n   * @returns {Promise}\n   */\n  _createOneOnOne(params) {\n    const payload = this._prepareConversationForCreation(params);\n\n    payload.tags = ['ONE_ON_ONE'];\n\n    return this._create(payload);\n  },\n\n  /**\n   * @param {Object} conversation\n   * @private\n   * @returns {Promise}\n   */\n  _inferConversationUrl(conversation) {\n    if (conversation.id) {\n      return this.webex.internal.feature.getFeature('developer', 'web-high-availability')\n        .then((haMessagingEnabled) => {\n          if (haMessagingEnabled) {\n            // recompute conversation URL each time as the host may have changed\n            // since last usage\n            return this.webex.internal.device.getServiceUrl('conversation')\n              .then((url) => {\n                conversation.url = `${url}/conversations/${conversation.id}`;\n\n                return conversation;\n              });\n          }\n          if (!conversation.url) {\n            return this.webex.internal.device.getServiceUrl('conversation')\n              .then((url) => {\n                conversation.url = `${url}/conversations/${conversation.id}`;\n                /* istanbul ignore else */\n                if (process.env.NODE_ENV !== 'production') {\n                  this.logger.warn('conversation: inferred conversation url from conversation id; please pass whole conversation objects to Conversation methods');\n                }\n\n                return conversation;\n              });\n          }\n\n          return Promise.resolve(conversation);\n        });\n    }\n\n    return Promise.resolve(conversation);\n  },\n\n  /**\n   * @param {Object} options\n   * @private\n   * @returns {Promise<Array<Activity>>}\n   */\n  _listActivities(options) {\n    return this._list({\n      service: 'conversation',\n      resource: options.mentions ? 'mentions' : 'activities',\n      qs: omit(options, 'mentions')\n    });\n  },\n\n  /**\n   * @param {Object} options\n   * @private\n   * @returns {Promise<Array<Conversation>>}\n   */\n  _list(options) {\n    options.qs = Object.assign({\n      personRefresh: true,\n      uuidEntryFormat: true,\n      activitiesLimit: 0,\n      participantsLimit: 0\n    }, options.qs);\n\n    return this.request(options)\n      .then((res) => {\n        if (!res.body || !res.body.items || res.body.items.length === 0) {\n          return [];\n        }\n\n        const {items} = res.body;\n\n        if (last(items).published < items[0].published) {\n          items.reverse();\n        }\n\n        return Promise.all(items.map((item) => this._recordUUIDs(item)))\n          // eslint-disable-next-line max-nested-callbacks\n          .then(() => items);\n      });\n  },\n\n  /**\n   * @param {Object} params\n   * @param {Object} options\n   * @private\n   * @returns {Promise<Conversation>}\n   */\n  _maybeCreateOneOnOneThenPost(params, options) {\n    return this.get(defaults({\n      // the use of uniq in Conversation#create guarantees participant[1] will\n      // always be the other user\n      user: params.participants[1]\n    }), Object.assign(options, {includeConvWithDeletedUserUUID: true, includeParticipants: true}))\n      .then((conversation) => {\n        if (params.comment || params.html) {\n          return this.post(conversation, {content: params.html, displayName: params.comment})\n            .then((activity) => {\n              conversation.activities.items.push(activity);\n\n              return conversation;\n            });\n        }\n\n        return conversation;\n      })\n      .catch((reason) => {\n        if (reason.statusCode !== 404) {\n          return Promise.reject(reason);\n        }\n\n        return this._createOneOnOne(params);\n      });\n  },\n\n  /**\n   * @param {Object} params\n   * @private\n   * @returns {Object}\n   */\n  _prepareConversationForCreation(params) {\n    const payload = {\n      activities: {\n        items: [\n          this.expand('create')\n        ]\n      },\n      objectType: 'conversation',\n      kmsMessage: {\n        method: 'create',\n        uri: '/resources',\n        userIds: cloneDeep(params.participants),\n        keyUris: []\n      }\n    };\n\n    if (params.displayName) {\n      payload.displayName = params.displayName;\n    }\n\n    params.participants.forEach((participant) => {\n      payload.activities.items.push(this.expand('add', {\n        objectType: 'person',\n        id: participant\n      }));\n    });\n\n    if (params.comment) {\n      payload.activities.items.push(this.expand('post', {\n        objectType: 'comment',\n        content: params.html,\n        displayName: params.comment\n      }));\n    }\n\n    return payload;\n  },\n\n  /**\n   * @param {Object} conversation\n   * @private\n   * @returns {Promise}\n   */\n  _recordUUIDs(conversation) {\n    if (!conversation.participants || !conversation.participants.items) {\n      return Promise.resolve(conversation);\n    }\n\n    return Promise.all(conversation.participants.items.map((participant) => {\n      // ROOMs do not have email addresses, so there's no point attempting to\n      // record their UUIDs.\n      if (participant.type === 'ROOM') {\n        return Promise.resolve();\n      }\n\n      return this.webex.internal.user.recordUUID(participant)\n        .catch((err) => this.logger.warn(`Could not record uuid for ${participant.id || participant.entryUUID}`, err));\n    }));\n  }\n});\n\n[\n  'favorite',\n  'hide',\n  'lock',\n  'mute',\n  'unfavorite',\n  'unhide',\n  'unlock',\n  'unmute'\n].forEach((verb) => {\n  Conversation.prototype[verb] = function submitSimpleActivity(conversation, activity) {\n    return this._inferConversationUrl(conversation)\n      .then(() => this.prepare(activity, {\n        verb,\n        object: this.prepareConversation(conversation)\n      }))\n      .then((a) => this.submit(a));\n  };\n});\n\n[\n  'assignModerator',\n  'unassignModerator'\n].forEach((verb) => {\n  Conversation.prototype[verb] = function submitModerationChangeActivity(conversation, moderator, activity) {\n    return Promise.all([\n      this._inferConversationUrl(conversation),\n      moderator ? this.webex.internal.user.asUUID(moderator) : this.webex.internal.device.userId\n    ])\n      .then(([c, userId]) => this.prepare(activity, {\n        verb,\n        target: this.prepareConversation(c),\n        object: {\n          id: userId,\n          objectType: 'person'\n        }\n      }))\n      .then((a) => this.submit(a));\n  };\n});\n\n/**\n * Sets/unsets space property for convo\n * @param {Object} conversation\n * @param {string} tag\n * @param {Activity} activity\n * @returns {Promise<Activity>}\n */\n[\n  'setSpaceProperty',\n  'unsetSpaceProperty'\n].forEach((fnName) => {\n  const verb = fnName.startsWith('set') ? 'set' : 'unset';\n\n  Conversation.prototype[fnName] = function submitSpacePropertyActivity(conversation, tag, activity) {\n    if (!isString(tag)) {\n      return Promise.reject(new Error('`tag` must be a string'));\n    }\n\n    return this._inferConversationUrl(conversation)\n      .then(() => this.prepare(activity, {\n        verb,\n        target: this.prepareConversation(conversation),\n        object: {\n          tags: [tag],\n          objectType: 'spaceProperty'\n        }\n      }))\n      .then((a) => this.submit(a));\n  };\n});\n\n[\n  'tag',\n  'untag'\n].forEach((verb) => {\n  Conversation.prototype[verb] = function submitObjectActivity(conversation, object, activity) {\n    if (!isObject(object)) {\n      return Promise.reject(new Error('`object` must be an object'));\n    }\n\n    const c = this.prepareConversation(conversation);\n\n    return this._inferConversationUrl(conversation)\n      .then(() => this.prepare(activity, {\n        verb,\n        target: c,\n        object: Object.assign(c, object)\n      }))\n      .then((a) => this.submit(a));\n  };\n});\n\nexport default Conversation;\n"]}